<!DOCTYPE html>
<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta id="viewport" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>往来核验报表</title>
	<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="bootstrap/bootstrap-datepicker/bootstrap-datetimepicker.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/image.css">
	<link rel="stylesheet" type="text/css" href="css/menu.css">
	<link rel="stylesheet" type="text/css" href="js/modal_files/common.css">
	<link rel="stylesheet" type="text/css" href="js/modal_files/modal.css">
	<link rel="stylesheet" type="text/css" href="datatables/media/css/jquery.dataTables.min.css">
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.validate.js"></script>
	<script type="text/javascript" src="js/modal_files/modal.js"></script>
	<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.scrollUp.min.js"></script>
	<script type="text/javascript" src="bootstrap/bootstrap-datepicker/bootstrap-datetimepicker.js"></script>
	<script type="text/javascript" src="bootstrap/bootstrap-datepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<script type="text/javascript" src="datatables/media/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
	<script type="text/javascript" src="js/highcharts/highcharts.js"></script>
	 <!--[if lt IE 9]><script type="text/javascript" src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script type="text/javascript" src="js/jquery.mergecell.js"></script>

	<link rel="stylesheet" type="text/css" href="bootstrap/suggest/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="bootstrap/suggest/bsv3.css">
	<script type="text/javascript" src="bootstrap/suggest/bsv3dropdown.js"></script>
	<script type="text/javascript" src="bootstrap/suggest/bootstrap-suggest.js?v=5"></script>

	<style type="text/css">
		.container{width:100% !important;}/*设置页面宽度为100%*/
		.navbar .brand{font-size:12px;}
		.userinfo{margin-left:0 !important;}/**由于导航栏目较多,临时加的,去掉边距*/
		.navbar-inverse .navbar-inner{padding-right:0 !important;}/**由于导航栏目较多,临时加的,去掉边距*/
		.navbar .nav > li > a{ padding:10px 12px 10px;}/**由于导航栏目较多,临时加的,减小导航条目之间的距离*/
	</style>
</head>
<body data-spy="scroll" data-target=".subnav" data-offset="50">
<div id="header"></div>
<div class="container">
	<div class="content">
		<div class="row-fluid">
  			 <div class="span2"></div>
			<div class="span10">
				<div class="row-fluid page-header">
					<div class="span10">
				        <h4>往来帐核验报表</h4>
				    </div>
				</div>
				<div class="row-fluid">
						<form class="alert form-search" id="form" action="#" method="get">
							<input type="hidden" name="filesId" id="filesId">
					    	<div class="row-fluid">
					    		<div class="row-fluid" style="margin-top:5px;"> 
							        <div class="span2">
							            <label>年月：</label>
							            <input class="input-small" id="var_begin_date" name="month" data-date-format="yyyy-mm" type="text" onchange="loadData();">
							         </div>
									<div class="span4">
										<label style="float: left; line-height: 30px;">往来单位：</label>
										<div class="input-group" style="float: left; width: 345px;">
											<input type="text" class="form-control" id="companyId" name="companyId">
											<div class="input-group-btn">
												<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
													<span class="caret"></span>
												</button>
												<ul class="dropdown-menu dropdown-menu-right" role="menu">
												</ul>
											</div>
											<!-- /btn-group -->
										</div>
									</div>
							         <div class="span3">
							            <label>状态 ：</label>
							            <select name="status" id="status">
							            	<option value="1">已核</option>
							            	<option value="2">待核</option>
							            	<option value="3">外部往来</option>
							            </select>
							         </div>
									<div class="span3" style="display: none;" id="groupId">
										<label>分组 ：</label>
										<select name="companyGroupId" id="companyGroupId"></select>
									</div>
							    </div>												    
					    	</div>
					    </form>
					</div>
				<div class="tabbable">
					<table class="table bj_fff table_style table-hover table-striped" data-url="com" id="balance-table">
					   	<thead>
						   <tr>
							   	<th>科目代码</th>
							   	<th>科目名称</th>
							   	<!--<th>币别</th>
								<th>期初借方余额</th>
								<th>期初贷方余额</th>
								<th>本期借方发生额</th>
								<th>本期贷方发生额</th>
								<th>本年借方累计</th>
								<th>本年贷方累计</th>-->
								<th>期末借方余额</th>
								<th>期末贷方余额</th>
							   	<th>核账科目代码</th>
							   	<th>核账科目名称</th>
							   	<th>期末借方余额</th>
							   	<th>期末贷方余额</th>
						   </tr>
					   	</thead>
						<tbody>
							<tr th:remove="all">
								<td>张三</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
						   	
						   </tr>	
					   </tbody>
					</table>
					<div>
						<button class="btn disabled" id="export-btn">导出到文件</button>
						<button class="btn disabled" id="amount-btn">查看合计</button>
					</div>
				</div>
				
			</div>
		</div> <!--content 结束-->
	</div> <!--container 结束-->
	<div class="container">
		<div class="content">
		<hr>
		  <footer class="footer">
			  <p>Copyright © 星河互联集团有限公司</p>
		  </footer>
		</div>
	</div>
 
</div>
<div id="user-list" style="display:none;">
<form class="well form-horizontal" method="post" id="yw0" novalidate="novalidate">
	<fieldset>
		<ul class="operate_user">
		</ul>
		<div class="control-group">
			<div class="controls">
				<input class="btn btn-success" type="button" value="确定" id="select-user-btn">		
			</div>
		</div>
	</fieldset>
</form>
</div>
<!-- 上传插件 -->
<script type="text/javascript" src="js/jquery.ui.widget.js"></script>
<script type="text/javascript" src="js/jquery.fileupload.js"></script>
<script type="text/javascript" src="bootstrap/bootstrap-datepicker/b_datemonth.js"></script>
<script type="text/javascript" th:inline="javascript">
$(function () {
	var loginUser = /*[[${session._user_login_}]]*/;
	if(loginUser.login=='admin' || loginUser.login=='data-admin') {
		$("#groupId").show();
	}

	var now = new Date();
	var preMonth = new Date(now.getTime() -((now.getDate()+1)*24*3600*1000));
	$("#var_begin_date" ).val(get_time(preMonth,true));
	$( "#var_begin_date" ).datetimepicker({ 
		language: "zh-CN",
		startView: 3, 
		minView: 3,
		endDate:now,
		todayBtn: true,
		autoclose:true
		});
	
	loadData();
});

$("#status").change(function(){
	loadData();
});
$("#companyGroupId").change(function(){
	loadData();
});
function loadData()
{
	var month = $("#var_begin_date").val();
	var companyId = $("#companyId").attr('data-id');
	var companyName = $("#companyName").val();
	var status = $("#status").val();
	var companyGroupId = $("#companyGroupId").val();
	if(month == '' || companyId == '' || companyId == undefined)
	{
		return;
	}
	var url = /*[[@{report/passed}]]*/;
	if(status == 2)
	{
		url = /*[[@{report/notPassed}]]*/;
	}
	else if(status == 3)
	{
		url = /*[[@{report/external}]]*/;
	}
	
	var params = {
		'month':month,
		'companyId':companyId,
		'companyName' : companyName
	};
	if(loginUser.login=='admin' || loginUser.login=='data-admin') {
		if(companyGroupId != -1){
			params["companyGroupId"] =companyGroupId
		}
	}
	var columns =[
		{
			name:'subjectCode'
		},
		{
			name:'subjectName'
		},
		{
			name:'finalDebitBalance'
		},
		{
			name:'finalCreditBalance'
		},
		{
			name:'contrastSubjectCode'
		},
		{
			name:'contrastSubjectName'
		},
		{
			name:'contrastFinalDebitBalance'
		},
		{
			name:'contrastFinalCreditBalance'
		}
	];
	$.loadTable({
		url:url,
		params:params,
		columns:columns,
		table:$("#balance-table"),
		loadComplete: function(data){
			//console.log(data);
			var empty = data.page.totalElements ==0;
			$("#export-btn").toggleClass('disabled',empty);
			$("#amount-btn").toggleClass('disabled',empty);
		}
	});
	
}
$("#export-btn").click(function(){
	
	if($(this).hasClass('disabled'))
	{
		return;
	}
	if(!confirm("确认要导出数据？"))
	{
		return;
	}
	var status = $("#status").val();
	var url = [[@{report/export/}]]+status;
	var month = $("#var_begin_date").val();
	var companyId = $("#companyId").attr('data-id');
	var companyGroupId = $("#companyGroupId").val();
	var params = $.param({month:month,companyId:companyId,companyGroupId:companyGroupId});
	//var params = $(".form-search").serialize();
	//console.log(url+"?"+params);
		window.location = url+"?"+params;
	
});


$("#amount-btn").click(function(){

	if($(this).hasClass('disabled'))
	{
		return;
	}
	var month = $("#var_begin_date").val();
	var companyId = $("#companyId").attr('data-id');
	var status = $("#status").val();
	var companyGroupId = $("#companyGroupId").val();
	if(month == '' || companyId == '')
	{
		return;
	}

	var _url = [[@{report/amount/}]] + companyId + '/' + month + '/' + status + '/' + companyGroupId;
	$(this).attr('data-url',_url);

	$(this).createModal({
		background: "#000",//设定弹窗之后的覆盖层的颜色
		width: "745px",//设定弹窗的宽度
		height: "450px",//设定弹窗的高度
		resizable: true,//设定弹窗是否可以拖动改变大小
		html: ""
	},function(){//回调函数的方法

	});
});
//填充数据
var url = /*[[@{companyGroup/getAll}]]*/;
$.ajax({
	type: 'POST',
	url: url,
	success: function (data) {
		if (data.code == 'OK') {
			$("#companyGroupId").html('<option value="-1">未选择</option>');
			var companyGroupList = data.values;
			for ( var i=0 ; i < companyGroupList.length ; i++ )
			{
				$("#companyGroupId").append('<option value="'+companyGroupList[i].id+'">'+ companyGroupList[i].title +'</option>');
			}

		}
	}
});
function initCompanyId() {
	$("#companyId").bsSuggest('init', {
		url: /*[[@{userCompany/get}]]*/,
		clearable: true,
		getDataMethod: "firstByUrl",
		effectiveFields:['companyName','aliasName1','aliasName2','aliasName3','aliasName4','aliasName5'],
		effectiveFieldsAlias: {companyName:'往来名称',aliasName1:'别名1',aliasName2:'别名2',aliasName3:'别名3',aliasName4:'别名4',aliasName5:'别名5'},
		searchFields: ['companyName'],
		idField: "id",
		keyField: "companyName",
		autoDropup: true,
		fnProcessData: function (json) {
			var index, len, data = {value: []};
			if (!json || !json.values || json.values.length === 0) {
				return false;
			}
			len = json.values.length;
			for (index = 0; index < len; index++) {
				data.value.push( json.values[index] );
			}
			return data;
		}
	}).on('onDataRequestSuccess', function (e, result) {
		//console.log('onDataRequestSuccess: ', result);
	}).on('onSetSelectValue', function (e, keyword, data) {
		loadData();
		//console.log('onSetSelectValue: ', keyword, data);
	}).on('onUnsetSelectValue', function () {
		//console.log('onUnsetSelectValue');
	});
}

initCompanyId();
</script>
</body>
</html>