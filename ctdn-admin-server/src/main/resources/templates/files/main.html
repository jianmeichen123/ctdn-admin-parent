<!DOCTYPE html>
<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta id="viewport" name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>科目余额表导入</title>
	<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="bootstrap/bootstrap-datepicker/bootstrap-datetimepicker.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/image.css">
	<link rel="stylesheet" type="text/css" href="css/menu.css">
	<link rel="stylesheet" type="text/css" href="js/modal_files/common.css">
	<link rel="stylesheet" type="text/css" href="js/modal_files/modal.css">
	<link rel="stylesheet" type="text/css" href="datatables/media/css/jquery.dataTables.min.css">
	<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="js/jquery.validate.js"></script>
	<script type="text/javascript" src="js/modal_files/modal.js"></script>
	<script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.scrollUp.min.js"></script>
	<script type="text/javascript" src="bootstrap/bootstrap-datepicker/bootstrap-datetimepicker.js"></script>
	<script type="text/javascript" src="bootstrap/bootstrap-datepicker/bootstrap-datetimepicker.zh-CN.js"></script>
	<script type="text/javascript" src="datatables/media/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="js/common.js"></script>
	<script type="text/javascript" src="js/highcharts/highcharts.js"></script>
	 <!--[if lt IE 9]><script type="text/javascript" src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script type="text/javascript" src="js/jquery.mergecell.js"></script>

	<link rel="stylesheet" type="text/css" href="bootstrap/suggest/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="bootstrap/suggest/bsv3.css">
	<script type="text/javascript" src="bootstrap/suggest/bsv3dropdown.js"></script>
	<script type="text/javascript" src="bootstrap/suggest/bootstrap-suggest.js?v=5"></script>

	<style type="text/css">
		.container{width:100% !important;}/*设置页面宽度为100%*/
		.navbar .brand{font-size:12px;}
		.userinfo{margin-left:0 !important;}/**由于导航栏目较多,临时加的,去掉边距*/
		.navbar-inverse .navbar-inner{padding-right:0 !important;}/**由于导航栏目较多,临时加的,去掉边距*/
		.navbar .nav > li > a{ padding:10px 12px 10px;}/**由于导航栏目较多,临时加的,减小导航条目之间的距离*/
	</style>

</head>
<body data-spy="scroll" data-target=".subnav" data-offset="50">
<div id="header"></div>
<div class="container">
	<div class="content">
		<div class="row-fluid">
  			 <div class="span2"></div>
			<div class="span10">
				<div class="row-fluid page-header">
					<div class="span10">
				        <h4>科目余额表导入</h4>
				    </div>
				</div>
				<div class="row-fluid">
						<form class="alert form-search" id="form" action="#" method="get">
							<input type="hidden" id="companyId" name="companyId" />
					    	<div class="row-fluid">
					    		<div class="row-fluid" style="margin-top:5px;"> 
							        <div class="span4">
							            <label>年月：</label>
							            <input class="input-middle" id="var_begin_date" name="period" data-date-format="yyyy-mm" type="text" onchange="searchRow();">
							         </div>
									<div class="span4">
										<label style="float: left; line-height: 30px;">往来单位：</label>
										<div class="input-group" style="float: left; width: 345px;">
											<input type="text" class="form-control" id="companyName" name="companyName">
											<div class="input-group-btn">
												<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
													<span class="caret"></span>
												</button>
												<ul class="dropdown-menu dropdown-menu-right" role="menu">
												</ul>
											</div>
										</div>
							         </div>
								</div>
							    <div class="row-fluid" style="margin-top:5px;"> 
									<div class="span14">
										<div class="file_box">
											<input id="fileupload" type="file" name="file" data-url="files/upload" >
								            <button class="file_btn btn">选择文件</button>
								            <span class="file_name"></span>
										</div>
								        <div class="span2 pull-right" style="font-size: 1.05em; width:100px;">
								            &nbsp;&nbsp;<input class="btn btn-success" type="button" value="导入" id="import-btn">   
								        </div>
							        </div>
							    </div>
							    
					    	</div>
					    </form>
					</div>
				<div class="tabbable">
					<table class="table bj_fff table_style table-hover table-striped" data-url="com" id="balance-table">
					   	<thead>
						   <tr>
								<th>科目代码</th>
								<th>科目名称</th>
								<th>币别</th>
								<th>期初借方余额</th>
								<th>期初贷方余额</th>
								<th>本期借方发生额</th>
								<th>本期贷方发生额</th>
								<th>本年借方累计</th>
								<th>本年贷方累计</th>
								<th>期末借方余额</th>
								<th>期末贷方余额</th>					   	
						   </tr>
					   	</thead>
						<tbody>
							<tr th:remove="all">
								<td>张三</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
								<td>张三1</td>
								<td>张三2</td>
						   	
						   </tr>	
					   </tbody>
					</table>
				</div>
				
			</div>
		</div> <!--content 结束-->
	</div> <!--container 结束-->
	<div class="container">
		<div class="content">
		<hr>
		  <footer class="footer">
			  <p>Copyright © 星河互联集团有限公司</p>
		  </footer>
		</div>
	</div>
 
</div>
<div id="user-list" style="display:none;">
<form class="well form-horizontal" method="post" id="yw0" novalidate="novalidate">
	<fieldset>
		<ul class="operate_user">
		</ul>
		<div class="control-group">
			<div class="controls">
				<input class="btn btn-success" type="button" value="确定" id="select-user-btn">		
			</div>
		</div>
	</fieldset>
</form>
</div>
<!-- 上传插件 -->
<script type="text/javascript" src="js/jquery.ui.widget.js"></script>
<script type="text/javascript" src="js/jquery.fileupload.js"></script>
<script type="text/javascript" src="bootstrap/bootstrap-datepicker/b_datemonth.js"></script>
<script type="text/javascript" th:inline="javascript">
$(function () {
	var now = new Date();
	var preMonth = new Date(now.getTime() -((now.getDate()+1)*24*3600*1000));
	$("#var_begin_date" ).val(get_time(preMonth,true));
	$( "#var_begin_date" ).datetimepicker({ 
		language: "zh-CN",
		startView: 3, 
		minView: 3,
		endDate:now,
		todayBtn: true,
		autoclose:true
	});

	$(".file_box #fileupload").change(function(){
		var value= $(this).val();
		if(value==""){
			$(".file_box .file_name").text("请选择文件");
		}else{
			$(".file_box .file_name").text(value)
		}
	})

	var fileData;
	$('#fileupload').fileupload({
		dataType: 'json',
		add: function (e, data) {
			fileData = data;
			$(".file_box .file_name").text(data.files[0].name);
            //data.submit();
        },
        always: function(){
        	$("#import-btn").removeClass('disabled');
        },
		done: function (e, data) {
			if(data.result.code == 'OK')
			{
				alert('导入成功');
				$(".file_box .file_name").text("");
				fileData = null;
			}
			else
			{
				alert(data.result.message);
			}
		}
	});

	$("#import-btn").click(function(){
		if($(this).hasClass('disabled'))
		{
			return;
		}
		if(typeof(fileData) == 'undefined' || fileData == null)
		{
			alert('请选择文件');
			return;
		}
		var fileName = fileData.files[0].name.split(".")[0];
		var date = $("#var_begin_date").val();
		var company =$("#companyName").attr('alt');
		var rightName = date+"-"+company
		if(fileName != rightName){
			alert('文件名格式不正确!(注:正确格式为:yyyy-MM-往来单位全称)');
			return false;
		}else{
			fileData.submit();
			$(this).addClass('disabled');
		}
	});

	searchRow();
});
//填充数据
//var url = /*[[@{userCompany/get}]]*/;
/*$.ajax({
	type : 'POST',
	url	: url,
	success : function(data){
		if(data.code == 'OK')
		{
			var ul = $(".operate_user");
			ul.empty();
			$.each(data.values,function(){
				ul.append('<li data-company-id="'+this.id+'">'+this.companyName+'</li>')
			});
			
			$("body").delegate(".operate_user li","click",function(){
				//单选
				$(this).siblings().removeClass("list_one_on");
				$(this).toggleClass("list_one_on");
			});
		}
	}
});

$("#accounts_into").click(function(){
    $("#accounts_into").createModal({
        background: "#000",//设定弹窗之后的覆盖层的颜色
        width: "700px",//设定弹窗的宽度
        height: "400",//设定弹窗的高度
        resizable: true,//设定弹窗是否可以拖动改变大小
        html:$("#user-list").html()
    },function(){//回调函数的方法
    	//选择用户
    	$("#select-user-btn").click(function(){
    		var $li = $(".operate_user .list_one_on");
    		if($li.length == 0)
    		{
    			alert('请选择往来单位');
    			return;
    		}
    		$("#companyId").val($li.data('companyId'));
    		$("#companyName").text($li.text());
    		$(".modal-close").click();
    		searchRow();
    	});
    });
});
 */
function searchRow()
{
	var month = $("#var_begin_date").val();
	var companyId = $("#companyName").attr('data-id');
	if(month == '' || companyId == '' || companyId == undefined)
	{
		return;
	}
	var url = /*[[@{balance/search}]]*/;
	var params = {
		'month':month,
		'companyId':companyId
	}
	var columns =[
		{
			name:'subjectCode'
		},
		{
			name:'subjectName'
		},
		{
			name:'currency'
		},
		{
			name:'initialDebitBalance'
		},
		{
			name:'initialCreditBalance'
		},
		{
			name:'currentDebitAmount'
		},
		{
			name:'currentCreditAmount'
		},
		{
			name:'debitYearAmount'
		},
		{
			name:'creditYearAmount'
		},
		{
			name:'finalDebitBalance'
		},
		{
			name:'finalCreditBalance'
		}
	];
	$.loadTable({
		url:url,
		params:params,
		columns:columns,
		table:$("#balance-table")
	});
	
}



function initCompanyId() {
	$("#companyName").bsSuggest('init', {
		url: /*[[@{userCompany/get}]]*/,
		clearable: true,
		getDataMethod: "firstByUrl",
		effectiveFields:['companyName','aliasName1','aliasName2','aliasName3','aliasName4','aliasName5'],
		effectiveFieldsAlias: {companyName:'往来名称',aliasName1:'别名1',aliasName2:'别名2',aliasName3:'别名3',aliasName4:'别名4',aliasName5:'别名5'},
		searchFields: ['companyName'],
		idField: "id",
		keyField: "companyName",
		autoDropup: true,
		fnProcessData: function (json) {
			var index, len, data = {value: []};
			if (!json || !json.values || json.values.length === 0) {
				return false;
			}
			len = json.values.length;
			for (index = 0; index < len; index++) {
				data.value.push( json.values[index] );
			}
			return data;
		}
	}).on('onDataRequestSuccess', function (e, result) {
		//console.log('onDataRequestSuccess: ', result);
	}).on('onSetSelectValue', function (e, keyword, data) {
		console.log('onSetSelectValue: ', keyword, data);
		$("#companyId").val(data.id);
		searchRow();
	}).on('onUnsetSelectValue', function () {
		//console.log('onUnsetSelectValue');
	});
}

initCompanyId();
</script>
</body>
</html>